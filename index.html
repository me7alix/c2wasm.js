<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>c2wasm demo</title>
		<style>
			h1 { margin-top: 0; }

			html, body {
				height: 100%;
				margin: 0;
			}

			body {
				background: #0b0b0b;
				color: #ddd;
				font-family: monospace;

				display: flex;
				flex-direction: column;

				padding: 12px;
				box-sizing: border-box;
			}

			#editor {
				width: 100%;
				height: 260px;
				background: #111;
				color: #9f9;
				padding: 10px;
				border: 1px solid #222;
				box-sizing: border-box;
				resize: vertical;
			}

			input,
			button {
				background: #151515;
				color: #ddd;
				border: 1px solid #333;
				padding: 6px;
				margin: 6px 4px;
				font-family: monospace;
			}

			#console {
				background: #000;
				color: #fff;
				padding: 10px;
				white-space: pre-wrap;

				margin-top: 8px;
				width: 100%;
				box-sizing: border-box;
				border: 1px solid #222;

				flex: 1;
				resize: none;
			}
		</style>
	</head>

	<body>
		<h1>C to WebAssembly compiler</h1>
		<textarea id="editor"></textarea>
		<div>
			<button id="compileBtn">Compile</button>
			<label>fn: <input id="fname" value="fib" /></label>
			<label>args: <input id="fargs" value="10" /></label>
			<button id="runBtn">Run</button>
			<button id="clearBtn">Clear</button>
			<label>&nbsp;&nbsp;&nbsp;</label>
			<label>examples:</label>
			<button id="fibEx">Fibonacci sequence</button>
			<button id="mandEx">Mandelbrot set</button>
		</div>
		<textarea readonly id="console"></textarea>

		<script src="https://cdn.jsdelivr.net/npm/wabt@1.0.39/index.min.js"></script>

		<script type="module">
			import { compileCToWat } from "./c2wat.js";

			(async () => {
				async function loadExample(name) {
					const response = await fetch(`examples/${name}`);
					const text = await response.text();

					document.getElementById("editor").value = text;
				}

				loadExample("fibseq.c")

				const out = document.getElementById("console");
				const log = (...a) => (out.textContent += a.join("") + "\n");
				const logch = (ch) => (out.textContent += ch);

				let wabt = await WabtModule();
				let instance = null;

				document.getElementById("fibEx").addEventListener("click", () => {
					document.getElementById("fname").value = "fib"
					document.getElementById("fargs").value = "10"
					loadExample("fibseq.c")
				})

				document.getElementById("mandEx").addEventListener("click", () => {
					document.getElementById("fname").value = "main"
					document.getElementById("fargs").value = ""
					loadExample("mandset.c")
				})

				document.getElementById("compileBtn").addEventListener("click", async () => {
					out.textContent = "";
					try {
						const code = document.getElementById("editor").value;
						let wat = "";

						try {
							wat = compileCToWat(code);
							console.log(wat);
						} catch (e) {
							log(e);
							log(e.stack)
							return;
						}

						function print_int(v)   { log("$ ", v); }
						function print_float(v) { log("$ ", v); }
						function print_char(v)  { logch(String.fromCharCode(v)); }

						const mod = wabt.parseWat("module.wat", wat);
						const bin = mod.toBinary({ log: false, canonicalize_lebs: true });
						const wasmBytes = bin.buffer;
						const res = await WebAssembly.instantiate(wasmBytes, {
							env: { print_int, print_float, print_char }
						});

						instance = res.instance;
						log("ok. exports:");
						Object.keys(instance.exports).forEach((k) => log(" - ", k));
					} catch (e) {
						log("error: ", e && e.message ? e.message : String(e));
					}
				});

				document.getElementById("runBtn").addEventListener("click", () => {
					if (!instance) {
						log("compile first");
						return;
					}

					const name = document.getElementById("fname").value.trim();
					const raw = document.getElementById("fargs").value.trim();
					const args = raw === "" ? [] : raw.split(",").map((s) => Number(s.trim()));

					try {
						const fn = instance.exports[name];
						if (typeof fn !== "function") {
							log("no export: ", name);
							return;
						}

						const r = fn(...args);
						log("result: ", r);
					} catch (e) {
						log("runtime error:", e && e.message ? e.message : String(e));
					}
				});

				document.getElementById("clearBtn").
					addEventListener("click", () => (out.textContent = ""));
			})();
		</script>
	</body>
</html>
